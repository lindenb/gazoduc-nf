plugins {
  id 'nf-schema@2.0.0'
}



params {
	help = false
	prefix = ""
	fasta = null
	gtf = null
	samplesheet = null
	bam2fastq_method = "samtools"
	with_cram = true
	with_fastp = true
	with_fastqc = true
	with_seqkit_split2 = true
	seqkit_split2_args = "--by-length 3G "
	with_bqsr = true
	with_delly = true
	with_somalier = true
	with_manta = true
	with_indexcov = true
	with_pb_deepvariant = true
	with_graphtyper = true
	with_haplotype_caller = true
	with_markdup = true
	with_truvari = true
	with_smoove = true
	with_pb_haplotypecaller = true
	markdup_method = "gatk"
	orad_directory = null
	dbsnp = null

	known_indels_vcf = null
	/* how to map fastq (dragmap|bwa|pb) */
	mapper = "bwa"
	/* location of bwa index */
	bwa_index_directory = null
	/** location of dragmap index */
	dragmap_index_directory=null
	}

includeConfig "../../config/nextflow.config"
includeConfig "../../config/common.apptainer.config"

params {


/** CSV file with header giving extra info about each sample */
sampleinfo = null
/** extra bam files */
exta_bams = null
/** capture BED */
bed=null
outdir="results"
hts_type = "WGS" /* WGS|WES */

with_multiqc = true
with_bam_qc = true



with_cnvnator = true
with_bcftools_call = true
with_freebayes = true



makewindows_args = "-w 1000000 -s 999900"
bed_cluster_args1 = "--size 10Mb " // callers like gatk+gvcf
bed_cluster_args2 = "--size 10Mb " //callers like freebayes, bcftools
}


validation {
	failUnrecognisedParams = false 
}


apptainer.runOptions = " --nv "



process {


withName : "DOWNLOAD_ORAD" {
	ext.local_dir = {params.orad_directory}
	}

withName : "FASTQC_BEFORE" {
	cpus = 10
	ext.prefix = "raw"
	}

withName : "FASTQC_AFTER" {
	cpus = 10
	ext.prefix = "trim"
	}

withName : "FASTP" {
	cpus = 10
	}

withName: "BAM_QC:SAMTOOLS_FLAGSTATS" {
	ext.args1 = {params.hts_type.equalsIgnoreCase("wes")?"-M":""}
	}

withName: "MAP_BWA:SEQKIT_SPLIT:SEQKIT_SPLIT2" {
	ext.args1 = {"${params.seqkit_split2_args}"}
}

withName : "PB_FQ2BAM" {
	conda = null
	//container = {params.apptainer_images.parabricks}
	//container = "/LAB-DATA/GLiCID/users/lindenbaum-p@univ-nantes.fr/APPTAINER/parabricks-4.6.0-1.sif"
	//beforeScript = "module load nvhpc apptainer"
	ext.with_bqsr = {"${params.with_bqsr}"}
	ext.gpus = 2
	ext.cpu_per_gpu=24
	maxForks = 1
	publishDir = [
          path:{"${params.outdir}/bam/${meta.id}"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bam,cram,bai,crai,md5}',
          mode: "copy",
          overwrite : true
          ]

	}

withName : "PB_HAPCALLER" {
	conda = null
	//container = {params.apptainer_images.parabricks}
	//beforeScript = "module load nvhpc apptainer"
	ext.gpus = 2
	ext.cpu_per_gpu=24
	maxForks = 1
	}

withName: "PB_DEEPVARIANT:DEEPVARIANT" {
	conda = null
	//container = {params.apptainer_images.parabricks}
	//beforeScript = "module load nvhpc apptainer"
	accelerator = [request:2, type: 'A100-PCIE-40GB']
	ext.cpu_per_gpu=24
	maxForks = 1
}

withName : "PB_BAM2FQ" {
	conda = null
	//container = {params.apptainer_images.parabricks}
	//beforeScript = "module load nvhpc apptainer"
	ext.gpus = 2
	ext.cpu_per_gpu=24
	maxForks = 1
	}

withName : "PREPARE_ONE_REFERENCE:PREPARE_REFERENCE:SCATTER_TO_BED:SCATTER_INTERVALS_BY_NS" {
	ext.output_type = "ACGT"
	ext.max_to_merge = 1
	}

withName : "MANTA_SINGLE:MANTA" {
	cpus= 10
}

withName: "INDEXCOV:INDEXCOV_REBUILD_BAI" {
	cpus = 10
}

  withName : "DELLY:SCATTER_TO_BED:SCATTER_INTERVALS_BY_NS" {
    ext.output_type = "N"
    ext.max_to_merge = 1
  }

withName: "BEDTOOLS_MAKEWINDOWS" {
		ext.args = {params.makewindows_args}
		}


withName: "MAP_BWA:BQSR:BED_CLUSTER" {
	ext.args = "--size 50mb "
	}

/** for callers like hapcaller+gvcf */
withName: "BED_CLUSTER1" {
		ext.args = {params.bed_cluster_args1}
		}
/** for callers like bcftoools/freebayes */
withName: "BED_CLUSTER2" {
		ext.args = {params.bed_cluster_args2}
		}

withName: "HAPLOTYPECALLER:HAPCALLER" {
	array = 100
	}

withName: "PB_HAPLOTYPECALLER:GLNEXUS_GENOTYPE" {
	ext.config = "gatk"
	array = 100
}

withName: "GRAPHTYPER:GTYPER" {
	array = 100
}

withName : "PB_DEEPVARIANT:GLNEXUS_GENOTYPE" {
	ext.config = "DeepVariantWGS"
	array = 100
}

withName : "HAPLOTYPECALLER:FIND_GVCF_BLOCKS" {
	ext.args1 = "--merge-size 1Mb"
}

//
withName: "PB_HAPLOTYPECALLER:BCFTOOLS_CONCAT" {
      publishDir = [
          path:{"${params.outdir}/variants/pb_haplotypecaller"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bcf,csi,vcf.gz,tbi}',
          mode: "copy",
          overwrite : true
          ]
	}

withName: "PB_DEEPVARIANT:BCFTOOLS_CONCAT" {
      publishDir = [
          path:{"${params.outdir}/variants/pb_deepvariant"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bcf,csi,vcf.gz,tbi}',
          mode: "copy",
          overwrite : true
          ]
	}

withName: "HAPLOTYPECALLER:BCFTOOLS_CONCAT" {
      publishDir = [
          path:{"${params.outdir}/variants/haplotypecaller"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bcf,csi,vcf.gz,tbi}',
          mode: "copy",
          overwrite : true
          ]
	}

withName: "BCFTOOLS_CALL:BCFTOOLS_CONCAT" {
      publishDir = [
          path:{"${params.outdir}/variants/bcftools"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bcf,csi,vcf.gz,tbi}',
          mode: "copy",
          overwrite : true
          ]
	}

withName: "FREEBAYES_CALL:BCFTOOLS_CONCAT" {
      publishDir = [
          path:{"${params.outdir}/variants/freebayes"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{bcf,csi,vcf.gz,tbi}',
          mode: "copy",
          overwrite : true
          ]
	}


withName: "BCFTOOLS_STATS|BCFTOOLS_GUESS_PLOIDY" {
	publishDir = [
          path:{"${params.outdir}/variants/${meta.id}/qc"},
          saveAs: { filename -> "${params.prefix}$filename" },
          pattern : '*.{txt,tsv}',
          mode: "copy",
          overwrite : true
          ]
}

withName: "CNVNATOR:ONE_FILE_PER_CONTIG" {
		ext.regex = "^((chr)?[0-9XY]+)\$"
}

withName: "MULTIQC" {
	publishDir = [
		path: { "${params.outdir}/multiqc" },
		mode: "copy",
		pattern : '*.{zip}',
		overwrite : true
		]
	}

withName : "SMOOVE_CALL|SMOOVE_GENOTYPE|SMOOVE_MERGE|SMOOVE_PASTE|SMOOVE:SMOOVE_CALL|SMOOVE:SMOOVE_GENOTYPE|SMOOVE:SMOOVE_MERGE|SMOOVE:SMOOVE_PASTE" {
	//beforeScript = "module load apptainer"
	//container = {params.apptainer_images.smoove}
	conda= null
	}

withName: "MOSDEPTH" {
	memory = "50G"
	cpus = 10
	}

}

